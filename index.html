<script src="./build/unlisp.js"></script>
<script>

function setString (ptr, str) {
    const view = new TextEncoder("utf-8").encode(str)
    Module.HEAP8.set(view, ptr);
}

function getString (ptr, size) {
    const view = Module.HEAPU8.subarray(ptr, ptr + size);
    return new TextDecoder("utf-8").decode(view)
}

Module.onRuntimeInitialized = async _ => {
    const api = {
        version: Module.cwrap('version', 'number', []),
        lisp_evaluate: Module.cwrap('lisp_evaluate', 'number', ['number']),
    }

    console.log(`Uniot lisp version: ${api.version()}`)

    const input_ptr = Module._malloc(1024);
    const output_ptr = Module._malloc(1024);

    let error = false
    const script = '(+ 1 1) (+ 1 2) (+ 1 3) ?'
    setString(input_ptr, script)
    let output_size = api.lisp_evaluate(input_ptr, output_ptr)
    if (output_size < 0) {
        error = true
        output_size *= -1
    }
    const result = getString(output_ptr, output_size)
    
    console.log(`Script: ${script}`)
    console.log(`Result:\n${result}`)
    console.log(JSON.parse(result))
    error && console.error('^^^ ERROR OCCURRED!')

    Module._free(input_ptr)
    Module._free(output_ptr)
}

</script>
